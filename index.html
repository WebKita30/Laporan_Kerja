<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard Borongan kerja - Privat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 0;
      }

      /* Tampilan Layar Login & Blokir */
      #auth-screen {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: #1e3c72;
        color: white;
        padding: 20px;
      }
      .auth-box {
        background: white;
        color: #333;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        width: 100%;
        max-width: 400px;
        text-align: center;
      }

      /* Dashboard Area */
      #main-content {
        display: none; /* Sembunyi sebelum login */
        padding: 15px;
      }
      .container {
        max-width: 1000px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .header-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #eee;
      }

      h1 {
        color: #1e3c72;
        margin: 0;
        font-size: 22px;
      }

      /* Form Input */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }
      input,
      select,
      .btn-main {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 14px;
      }
      .btn-main {
        background: #1e3c72;
        color: white;
        border: none;
        font-weight: bold;
        cursor: pointer;
      }

      /* Tabel */
      .table-wrapper {
        overflow-x: auto;
        border: 1px solid #eee;
        border-radius: 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th {
        background: #1e3c72;
        color: white;
        padding: 12px;
        font-size: 13px;
      }
      td {
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
        text-align: center;
        font-size: 13px;
      }
      .tanggal-row {
        background: #eef3ff;
        font-weight: bold;
        text-align: left;
        padding-left: 10px;
      }
      .total-harian {
        background: #fafafa;
        font-weight: bold;
        color: #28a745;
      }

      /* Tombol-Tombol */
      .btn-action {
        width: 100%;
        padding: 15px;
        margin-top: 10px;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
      }
      .btn-pdf {
        background: #34495e;
        color: white;
      }
      .btn-total {
        background: #28a745;
        color: white;
      }
      .btn-logout {
        background: #ff4757;
        color: white;
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 12px;
        border: none;
        cursor: pointer;
      }
      .btn-del {
        background: #ff4757;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
      }

      /* Footer & History */
      .footer-info {
        margin-top: 30px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        font-size: 11px;
        border: 1px dashed #ccc;
      }

      /* Hidden area untuk PDF */
      #pdfArea {
        position: absolute;
        left: -9999px;
        width: 800px;
        background: white;
        padding: 30px;
      }
    </style>
  </head>
  <body>
    <div id="auth-screen">
      <div class="auth-box" id="authBox">
        <h2>üîê Keamanan Sistem</h2>
        <p>Silakan daftar/masuk untuk mengakses dashboard.</p>
        <input
          type="password"
          id="passInput"
          placeholder="Masukkan Password"
          style="width: 100%; margin-bottom: 15px"
        />
        <button onclick="prosesLogin()" class="btn-main" style="width: 100%">
          MASUK KE SISTEM
        </button>
      </div>
    </div>

    <div id="main-content">
      <div class="container">
        <div class="header-flex">
          <h1>üìä Borongan kerja</h1>
          <button class="btn-logout" onclick="keluarSistem()">üö™ Keluar</button>
        </div>

        <div class="form-grid">
          <input type="date" id="tglInput" />
          <select id="ukInput">
            <option value="">-- Pilih Ukuran --</option>
            <option data-harga="10.5">45‚Äì54 cm (Rp 10.5)</option>
            <option data-harga="11.4">55‚Äì64 cm (Rp 11.4)</option>
            <option data-harga="12.6">65‚Äì74 cm (Rp 12.6)</option>
            <option data-harga="13.6">75‚Äì84 cm (Rp 13.6)</option>
            <option data-harga="17">85‚Äì94 cm (Rp 17)</option>
          </select>
          <input type="number" id="qtyInput" placeholder="Jumlah Qty" />
          <button class="btn-main" onclick="tambahData()">Tambah Data</button>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Ukuran</th>
                <th>Harga</th>
                <th>Qty</th>
                <th>Total</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="mainTabel"></tbody>
            <tfoot
              id="rowGrandTotal"
              style="display: none; background: #e9f7ef"
            >
              <tr>
                <td colspan="3"><strong>TOTAL KESELURUHAN</strong></td>
                <td
                  id="valGrandTotal"
                  style="font-weight: bold; color: #1e3c72"
                ></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <button class="btn-action btn-total" onclick="hitungSemua()">
          üßÆ HITUNG TOTAL KESELURUHAN
        </button>
        <button class="btn-action btn-pdf" onclick="cetakPDF()">
          üì• DOWNLOAD LAPORAN PDF
        </button>

        <div class="footer-info">
          <strong>Riwayat Akses Perangkat:</strong>
          <div id="logAkses" style="margin-top: 5px; color: #555">
            Belum ada riwayat.
          </div>
          <hr style="border: 0; border-top: 1px solid #ddd; margin: 10px 0" />
          <p style="color: red; margin-bottom: 5px">
            * Tombol Reset di bawah hanya untuk pindah HP (Hapus Semua Data):
          </p>
          <button
            onclick="resetTotal()"
            style="
              background: #333;
              color: white;
              border: none;
              padding: 5px 10px;
              border-radius: 5px;
              cursor: pointer;
            "
          >
            Hapus Semua Data & Kunci
          </button>
        </div>
      </div>
    </div>

    <div id="pdfArea">
      <h2 style="text-align: center">LAPORAN HASIL KERJA BORONGAN</h2>
      <p id="pdfTimestamp" style="text-align: center; font-size: 12px"></p>
      <table style="width: 100%; border: 1px solid black">
        <thead>
          <tr style="background: #eee">
            <th>Ukuran</th>
            <th>Harga</th>
            <th>Jumlah</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="pdfTabelBody"></tbody>
      </table>
    </div>

    <script>
      // === KONFIGURASI ===
      const PASS_SISTEM = "kerja2026";
      const rupiah = (n) => "Rp " + Number(n).toLocaleString("id-ID");

      // FUNGSI CEK PERANGKAT
      function getFingerprint() {
        return navigator.userAgent + screen.width + "x" + screen.height;
      }

      // === LOGIKA LOGIN & AUTO-LOGIN ===
      window.onload = function () {
        const idTerkunci = localStorage.getItem("kerja_device_id");
        const idSekarang = getFingerprint();
        const statusLogin = localStorage.getItem("kerja_is_logged_in");

        // 1. Cek Blokir Perangkat
        if (idTerkunci && idTerkunci !== idSekarang) {
          document.getElementById("authBox").innerHTML = `
            <h2 style="color:#ff4757">üö´ AKSES DITOLAK</h2>
            <p>Sistem ini sudah terkunci pada perangkat lain.<br>Gunakan perangkat asli atau hubungi admin.</p>
          `;
          return;
        }

        // 2. Cek Auto-Login
        if (statusLogin === "true") {
          tampilkanDashboard();
        }

        // Set default tanggal hari ini
        document.getElementById("tglInput").value = new Date()
          .toISOString()
          .slice(0, 10);
      };

      function prosesLogin() {
        const input = document.getElementById("passInput").value;
        if (input === PASS_SISTEM) {
          // Kunci perangkat secara permanen
          if (!localStorage.getItem("kerja_device_id")) {
            localStorage.setItem("kerja_device_id", getFingerprint());
          }

          // Set status login permanen (localStorage)
          localStorage.setItem("kerja_is_logged_in", "true");

          // Catat Riwayat
          let logs = JSON.parse(localStorage.getItem("kerja_logs") || "[]");
          logs.push(new Date().toLocaleString() + " - Login Berhasil");
          localStorage.setItem("kerja_logs", JSON.stringify(logs));

          tampilkanDashboard();
        } else {
          alert("Password Salah!");
        }
      }

      function keluarSistem() {
        if (
          confirm(
            "Apakah Anda ingin keluar? (Anda akan diminta password lagi nanti)",
          )
        ) {
          localStorage.setItem("kerja_is_logged_in", "false");
          location.reload();
        }
      }

      function tampilkanDashboard() {
        document.getElementById("auth-screen").style.display = "none";
        document.getElementById("main-content").style.display = "block";
        renderTabel();
        updateLogView();
      }

      function updateLogView() {
        let logs = JSON.parse(localStorage.getItem("kerja_logs") || "[]");
        document.getElementById("logAkses").innerHTML = logs
          .reverse()
          .slice(0, 3)
          .join("<br>");
      }

      // === LOGIKA DATA DASHBOARD ===
      let db = JSON.parse(localStorage.getItem("data_borongan") || "[]");

      function tambahData() {
        const tgl = document.getElementById("tglInput").value;
        const ukSelect = document.getElementById("ukInput");
        const qty = document.getElementById("qtyInput").value;

        if (!tgl || !ukSelect.value || !qty) return alert("Isi semua kolom!");

        const harga = parseFloat(
          ukSelect.options[ukSelect.selectedIndex].dataset.harga,
        );

        db.push({
          id: Date.now(),
          tanggal: tgl,
          ukuran: ukSelect.value,
          harga: harga,
          qty: parseInt(qty),
          total: harga * parseInt(qty),
        });

        localStorage.setItem("data_borongan", JSON.stringify(db));
        ukSelect.value = "";
        document.getElementById("qtyInput").value = "";
        document.getElementById("rowGrandTotal").style.display = "none";
        renderTabel();
      }

      function renderTabel() {
        const body = document.getElementById("mainTabel");
        body.innerHTML = "";

        // Kelompokkan berdasar tanggal
        const grup = db.reduce((acc, obj) => {
          acc[obj.tanggal] = acc[obj.tanggal] || [];
          acc[obj.tanggal].push(obj);
          return acc;
        }, {});

        Object.keys(grup)
          .sort()
          .reverse()
          .forEach((tgl) => {
            let harian = 0;
            body.innerHTML += `<tr class="tanggal-row"><td colspan="5">üìÖ ${new Date(tgl).toLocaleDateString("id-ID", { weekday: "long", day: "numeric", month: "short", year: "numeric" })}</td></tr>`;

            grup[tgl].forEach((item) => {
              harian += item.total;
              body.innerHTML += `
              <tr>
                <td>${item.ukuran}</td>
                <td>${item.harga}</td>
                <td>${item.qty}</td>
                <td>${rupiah(item.total)}</td>
                <td><button class="btn-del" onclick="hapusData(${item.id})">üóëÔ∏è</button></td>
              </tr>
            `;
            });
            body.innerHTML += `<tr class="total-harian"><td colspan="3">TOTAL PER HARI</td><td colspan="2">${rupiah(harian)}</td></tr>`;
          });
      }

      function hapusData(id) {
        db = db.filter((x) => x.id !== id);
        localStorage.setItem("data_borongan", JSON.stringify(db));
        renderTabel();
      }

      function hitungSemua() {
        const grand = db.reduce((a, b) => a + b.total, 0);
        document.getElementById("valGrandTotal").innerText = rupiah(grand);
        document.getElementById("rowGrandTotal").style.display =
          "table-footer-group";
      }

      async function cetakPDF() {
        if (db.length === 0) return alert("Tidak ada data untuk dicetak.");

        const pdfTabel = document.getElementById("pdfTabelBody");
        pdfTabel.innerHTML = "";
        let grand = 0;

        db.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal)).forEach(
          (item) => {
            grand += item.total;
            pdfTabel.innerHTML += `
            <tr>
              <td>${item.ukuran} (${item.tanggal})</td>
              <td>${item.harga}</td>
              <td>${item.qty}</td>
              <td>${rupiah(item.total)}</td>
            </tr>`;
          },
        );
        pdfTabel.innerHTML += `<tr style="background:#eee; font-weight:bold;"><td colspan="3">TOTAL KESELURUHAN</td><td>${rupiah(grand)}</td></tr>`;

        document.getElementById("pdfTimestamp").innerText =
          "Laporan Borongan - Dicetak pada: " + new Date().toLocaleString();

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const canvas = await html2canvas(document.getElementById("pdfArea"), {
          scale: 2,
        });
        doc.addImage(canvas.toDataURL("image/png"), "PNG", 10, 10, 190, 0);
        doc.save("Laporan_Borongan.pdf");
      }

      function resetTotal() {
        if (
          confirm(
            "HAPUS SEMUA DATA DAN BUKA KUNCI PERANGKAT? Tindakan ini tidak bisa dibatalkan.",
          )
        ) {
          localStorage.clear();
          location.reload();
        }
      }
    </script>
  </body>
</html>
