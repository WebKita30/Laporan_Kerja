<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard Kerja Borongan Kerjas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f4f6f8;
        padding: 12px;
        margin: 0;
      }

      /* Area Login */
      #auth-screen {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: #1e3c72;
        color: white;
        text-align: center;
      }
      .auth-box {
        background: white;
        color: #333;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 380px;
      }

      /* Dashboard Area (Disembunyikan jika belum login) */
      #main-content {
        display: none;
      }

      .container {
        max-width: 1100px;
        margin: auto;
        background: #fff;
        padding: 16px;
        border-radius: 14px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      h1 {
        color: #1e3c72;
        margin: 0;
        font-size: 24px;
      }

      .form {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .form input,
      .form select,
      .form button {
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
      }
      .form button {
        background: #1e3c72;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
      }

      .table-wrapper {
        max-height: 400px;
        overflow: auto;
        margin-top: 15px;
        border: 1px solid #ccc;
        border-radius: 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 520px;
      }
      thead th {
        position: sticky;
        top: 0;
        background: #1e3c72;
        color: #fff;
        padding: 8px;
        font-size: 13px;
      }
      td {
        padding: 6px;
        font-size: 12px;
        text-align: center;
        border-bottom: 1px solid #eee;
      }
      .tanggal-row {
        background: #eef3ff;
        font-weight: bold;
        text-align: left;
      }
      .total-harian {
        background: #fafafa;
        font-weight: bold;
      }
      tfoot {
        display: none;
        background: #e9f7ef;
        font-weight: bold;
      }
      .btn-del {
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 4px 8px;
        border-radius: 6px;
        cursor: pointer;
      }
      .btn {
        width: 100%;
        padding: 14px;
        margin-top: 12px;
        border: none;
        border-radius: 12px;
        font-weight: bold;
        cursor: pointer;
      }
      .btn-total {
        background: #0c7c59;
        color: #fff;
      }
      .btn-pdf {
        background: #34495e;
        color: #fff;
      }
      .btn-hapus {
        background: #c0392b;
        color: #fff;
      }
      .btn-logout {
        background: #ff4757;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 12px;
      }

      .history-card {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        font-size: 11px;
        color: #666;
        border: 1px dashed #ccc;
      }

      @media (max-width: 900px) {
        .form {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 600px) {
        .form {
          grid-template-columns: 1fr;
        }
      }

      /* PDF AREA */
      #pdfArea {
        position: absolute;
        left: -9999px;
        width: 800px;
        background: #fff;
        padding: 20px;
      }
      #pdfArea th,
      #pdfArea td {
        border: 1px solid #000;
        padding: 6px;
        font-size: 12px;
      }
    </style>
  </head>

  <body>
    <div id="auth-screen">
      <div class="auth-box" id="authBox">
        <h2>üîê Kunci Perangkat</h2>
        <p>Masukkan Password untuk mengakses dashboard.</p>
        <input
          type="password"
          id="passInput"
          placeholder="Password Akses"
          style="
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
          "
        />
        <button
          onclick="cekLogin()"
          style="
            width: 100%;
            padding: 12px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
          "
        >
          MASUK SISTEM
        </button>
      </div>
    </div>

    <div id="main-content">
      <div class="container">
        <div class="header-flex">
          <h1>üìä Dashboard Borongan</h1>
          <button class="btn-logout" onclick="logout()">üö™ KELUAR</button>
        </div>

        <div class="form">
          <input type="date" id="tanggal" />
          <select id="ukuran">
            <option value="">Pilih Ukuran</option>
            <option data-harga="10.5">45‚Äì54 cm</option>
            <option data-harga="11.4">55‚Äì64 cm</option>
            <option data-harga="12.6">65‚Äì74 cm</option>
            <option data-harga="13.6">75‚Äì84 cm</option>
            <option data-harga="17">85‚Äì94 cm</option>
          </select>
          <input type="number" id="hasil" placeholder="Jumlah" />
          <button onclick="tambah()">Tambah</button>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Ukuran</th>
                <th>Harga</th>
                <th>Jumlah</th>
                <th>Total</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tabelBody"></tbody>
            <tfoot id="tfootTotal">
              <tr>
                <td colspan="3">TOTAL KESELURUHAN</td>
                <td id="totalKeseluruhan">Rp 0</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <button class="btn btn-total" onclick="hitungTotalKeseluruhan()">
          üßÆ TOTALKAN KESELURUHAN
        </button>
        <button class="btn btn-pdf" onclick="downloadPDF()">
          üì• DOWNLOAD PDF
        </button>
        <button class="btn btn-hapus" onclick="hapusSemua()">
          üóëÔ∏è HAPUS SEMUA DATA
        </button>

        <div class="history-card">
          <strong>Info Perangkat:</strong> Terkunci secara otomatis pada browser
          ini.
          <hr style="border: 0; border-top: 1px solid #ddd; margin: 10px 0" />
          <button
            onclick="resetSistem()"
            style="
              background: #333;
              color: white;
              border: none;
              padding: 6px 10px;
              border-radius: 5px;
              cursor: pointer;
              font-size: 10px;
            "
          >
            RESET & PINDAH PERANGKAT
          </button>
        </div>
      </div>
    </div>

    <div id="pdfArea">
      <h2 style="text-align: center">LAPORAN KERJA BORONGAN</h2>
      <p id="pdfDate" style="text-align: center; font-size: 12px"></p>
      <table style="width: 100%; border-collapse: collapse">
        <thead>
          <tr>
            <th>Ukuran</th>
            <th>Harga</th>
            <th>Jumlah</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="pdfTabel"></tbody>
        <tfoot>
          <tr>
            <td colspan="3"><b>TOTAL KESELURUHAN</b></td>
            <td id="pdfGrandTotal"><b>Rp 0</b></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <script>
      const PASSWORD_RAHASIA = "kerja2026";
      let data = JSON.parse(localStorage.getItem("borongan_db")) || [];
      const rupiah = (n) => "Rp " + Number(n).toLocaleString("id-ID");

      // --- SISTEM KEAMANAN ---
      function getFingerprint() {
        return navigator.userAgent + screen.width + "x" + screen.height;
      }

      window.onload = function () {
        const lockedID = localStorage.getItem("device_id_locked");
        const currentID = getFingerprint();
        const isLoggedIn = localStorage.getItem("is_logged_in");

        // Cek Blokir
        if (lockedID && lockedID !== currentID) {
          document.getElementById("authBox").innerHTML =
            "<h2 style='color:red'>üö´ AKSES DITOLAK</h2><p>Perangkat tidak dikenali.</p>";
          return;
        }

        // Cek Auto Login
        if (isLoggedIn === "true") {
          showDashboard();
        }

        document.getElementById("tanggal").value = new Date()
          .toISOString()
          .slice(0, 10);
      };

      function cekLogin() {
        const input = document.getElementById("passInput").value;
        if (input === PASSWORD_RAHASIA) {
          localStorage.setItem("device_id_locked", getFingerprint());
          localStorage.setItem("is_logged_in", "true");
          showDashboard();
        } else {
          alert("Password Salah!");
        }
      }

      function logout() {
        if (confirm("Keluar dari sistem?")) {
          localStorage.setItem("is_logged_in", "false");
          location.reload();
        }
      }

      function showDashboard() {
        document.getElementById("auth-screen").style.display = "none";
        document.getElementById("main-content").style.display = "block";
        render();
      }

      function resetSistem() {
        if (confirm("Hapus semua data dan pindah perangkat?")) {
          localStorage.clear();
          location.reload();
        }
      }

      // --- LOGIKA DASHBOARD ---
      function hariTanggal(t) {
        const opsi = {
          weekday: "long",
          year: "numeric",
          month: "short",
          day: "numeric",
        };
        return new Date(t).toLocaleDateString("id-ID", opsi);
      }

      function tambah() {
        const uk = document.getElementById("ukuran");
        const hasil = document.getElementById("hasil");
        const tgl = document.getElementById("tanggal").value;

        if (!uk.value || !hasil.value) return alert("Lengkapi data!");

        const harga = Number(uk.options[uk.selectedIndex].dataset.harga);
        data.push({
          id: Date.now(),
          tanggal: tgl,
          ukuran: uk.value,
          harga: harga,
          hasil: Number(hasil.value),
          total: harga * Number(hasil.value),
        });

        localStorage.setItem("borongan_db", JSON.stringify(data));
        uk.value = "";
        hasil.value = "";
        document.getElementById("tfootTotal").style.display = "none";
        render();
      }

      function render() {
        const body = document.getElementById("tabelBody");
        body.innerHTML = "";
        const group = data.reduce((acc, curr) => {
          acc[curr.tanggal] = acc[curr.tanggal] || [];
          acc[curr.tanggal].push(curr);
          return acc;
        }, {});

        Object.keys(group)
          .sort()
          .reverse()
          .forEach((tgl) => {
            let harian = 0;
            body.innerHTML += `<tr class="tanggal-row"><td colspan="5">${hariTanggal(tgl)}</td></tr>`;
            group[tgl].forEach((d) => {
              harian += d.total;
              body.innerHTML += `
              <tr>
                <td>${d.ukuran}</td>
                <td>${rupiah(d.harga)}</td>
                <td>${d.hasil}</td>
                <td>${rupiah(d.total)}</td>
                <td><button class="btn-del" onclick="hapus(${d.id})">Hapus</button></td>
              </tr>`;
            });
            body.innerHTML += `<tr class="total-harian"><td colspan="3">TOTAL PER HARI</td><td>${rupiah(harian)}</td><td></td></tr>`;
          });
      }

      function hapus(id) {
        data = data.filter((i) => i.id !== id);
        localStorage.setItem("borongan_db", JSON.stringify(data));
        render();
      }

      function hapusSemua() {
        if (data.length && confirm("Hapus semua data?")) {
          data = [];
          localStorage.removeItem("borongan_db");
          render();
        }
      }

      function hitungTotalKeseluruhan() {
        const total = data.reduce((a, b) => a + b.total, 0);
        document.getElementById("totalKeseluruhan").innerText = rupiah(total);
        document.getElementById("tfootTotal").style.display =
          "table-footer-group";
      }

      async function downloadPDF() {
        if (!data.length) return alert("Data kosong!");
        const pdfTbl = document.getElementById("pdfTabel");
        pdfTbl.innerHTML = "";
        let grand = 0;

        // Sort data berdasarkan tanggal untuk laporan
        const sorted = [...data].sort(
          (a, b) => new Date(a.tanggal) - new Date(b.tanggal),
        );

        sorted.forEach((d) => {
          grand += d.total;
          pdfTbl.innerHTML += `<tr><td>${d.ukuran} (${d.tanggal})</td><td>${rupiah(d.harga)}</td><td>${d.hasil}</td><td>${rupiah(d.total)}</td></tr>`;
        });

        document.getElementById("pdfGrandTotal").innerText = rupiah(grand);
        document.getElementById("pdfDate").innerText =
          "Dicetak pada: " + new Date().toLocaleString();

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const canvas = await html2canvas(document.getElementById("pdfArea"), {
          scale: 2,
        });
        pdf.addImage(canvas.toDataURL("image/png"), "PNG", 10, 10, 190, 0);
        pdf.save("Laporan_Borongan_Kerjas.pdf");
      }
    </script>
  </body>
</html>
